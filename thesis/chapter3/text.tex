% Text for chapter 3
\chapter{Emission Diagnostics of Coronal Heating}\label{ch:diagnostics}

% Figure manager for Chapter 3
% spell-checker: disable %
\begin{pycode}[chapter3]
name = 'chapter3'
ch3 = texfigure.Manager(
    pytex,
    os.path.join('.', name),
    number=3,
    **{k: os.path.join('.', name, v) for k,v in manager_opts.items()}
)
\end{pycode}
% spell-checker: enable %

Diagnosing the properties of the underlying energy deposition in the corona is nontrivial as measurements are limited to remote sensing data from ground- and space-based instruments. Additionally, until the recently launched Parker Solar Probe mission \citep{fox_solar_2016}, \textit{in situ} measurements were limited to the solar wind at 1 AU. Thus, inferring the dynamics and energy budget of the coronal plasma necessitates the use of multiple diagnostics computed from the observed coronal emission at multiple wavelengths. In \autoref{sec:line_formation}, I discuss the physics of the formation of the optically thin solar spectrum. In \autoref{sec:dem}, I give an overview of the differential emission measure distribution (DEM) and discuss how the DEM can be used to understand the frequency of energy deposition in the solar atmosphere. Lastly, in \autoref{sec:timelag}, I discuss the time-lag analysis technique and show how it can be used to visualize large-scale cooling patterns in active regions.

\section{The CHIANTI Atomic Database}\label{subsec:chianti}

The CHIANTI atomic database \citep{dere_chianti_1997,young_chianti_1998,landi_chianti_1999,dere_chianti-atomic_2001,landi_chianti-atomic_2002,young_chianti-atomic_2003,landi_chianti-atomic_2006,landi_chianti-atomic_2006-1,dere_chianti_2009,landi_chiantiatomic_2009,young_chiantiatomic_2009,landi_chiantiatomic_2012,landi_chiantiatomic_2013,del_zanna_chianti_2015,young_chianti_2016} is an essential tool for performing spectroscopy of optically-thin astrophysical plasmas such as the solar corona. It is primarily used in the study of the solar atmosphere though it has broader astrophysical applications as well \citep[see Figure 4 of][]{young_chianti_2016}. The database provides information on atomic transitions for all ions of over 30 different elements, from hydrogen to zinc. For a given ion, CHIANTI provides wavelengths and energies (among other information) for many thousands of atomic transitions as well as various derived quantities, including the ionization and recombination rates, energy level populations, and spectral line intensities. Additionally, CHIANTI provides multiple measurements of elemental abundances in both the corona and photosphere. Data and routines are also included for computing the free-free and free-bound continuum emission. 

The CHIANTI project is an international collaboration between the University of Cambridge, the University of Michigan, and George Mason University and is an invaluable asset to the solar physics community. Version 1.0 of the database was released in 1995 and at the time of writing, the current version is 8.0.7. Users typically interact with the database via the provided Interactive Data Language (IDL) routines or the more recently-released ChiantiPy package \citep{landi_chiantiatomic_2012,barnes_chiantipy_2017}, an interface to CHIANTI implemented in the Python programming language. All work presented in this thesis makes heavy use of the CHIANTI atomic database via the fiasco Python package (see \autoref{ap:fiasco}).

\section{Spectral Line Formation}\label{sec:line_formation}

The solar corona is \textit{optically thin}, meaning that all emitted photons are observed and that these photons are not absorbed or scattered between the emission site and detector. Because these photons travel uninterrupted, they provide a direct signature of the properties of the coronal plasma. One of the primary mechanisms for the formation of spectral emission lines in the solar corona is the spontaneous radiative decay of an electron in an excited state $j$ to a lower energy state $i$,
\begin{equation}\label{eq:radiative_decay}
    X_{k,j} \to X_{k,i} + h\nu_{ji},
\end{equation}
where $X_k$ is an ion of element $X$ in ionization stage $k$, $\nu_{ji}$ is the frequency of the atomic transition, and $h\nu_{ji}$ is the energy of the emitted photon.

The intensity of a spectral line for an atomic transition of wavelength $\lambda_{ji}=c/\nu_{ji}$, where $c$ is the speed of light in a vacuum, is given by,
\begin{equation}\label{eq:intensity}
    I(\lambda_{ji}) = \frac{1}{4\pi}\int_\textup{LOS}\textup{d}h\,P(\lambda_{ji}),
\end{equation}
where the integration is taken along the line-of-sight (LOS) between the observer the emission site and $P(\lambda_{ji})$ is the \textit{emissivity}, or the radiative power per unit volume. The emissivity is given by,
\begin{equation}\label{eq:emissivity}
    P(\lambda_{ji}) = \frac{hc}{\lambda_{ji}}n_{X,k,j}A_{ji},
\end{equation}
where $n_{X,k,j}$ is the number density of $X_k$ ions in excited state $j$ and $A_{ji}$ is the probability of spontaneous emission, often referred to as the Einstein coefficient \citep{bradshaw_collisional_2013,del_zanna_solar_2018}.

In general, it is quite difficult to determine $n_{X,k,j}$, the density of ions in excited state $j$. As such, we can rewrite $n_{X,k,j}$ as,
\begin{align}\label{eq:nj}
    n_{X,k,j} &= \frac{n_{X,k,j}}{n_{X,k}}\frac{n_{X,k}}{n_X}\frac{n_X}{n_H}\frac{n_H}{n_e}n_e, \nonumber\\
              &= N_{X,k,j}f_{X,k}\textup{Ab}(X)\frac{n_H}{n_e}n_e,
\end{align}
where $n_e$ is the electron density, $\textup{Ab}(X)=n_X/n_H$ is the abundance of element $X$ relative to hydrogen, $n_H/n_e$ is the ratio of hydrogen ions to electrons, often approximated as $n_H/n_e\approx0.83$, $N_{X,k,j}=n_{X,k,j}/n_{X,k}$ is the level population of level $j$ or the fraction of $X_k$ ions in excited state $j$, and $f_{X,k}=n_{X,k}/n_X$ is the population fraction of ion $X_k$ \citep{del_zanna_solar_2018}. Plugging \autoref{eq:nj} into \autoref{eq:emissivity} yields a more convenient expression for the emissivity,
\begin{equation}\label{eq:emissivity_simplified}
    P(\lambda_{ji}) = 0.83\frac{hc}{\lambda_{ji}}\textup{Ab}(X)f_{X,k}N_{X,k,j}A_{ji}n_e.
\end{equation}
Both $\textup{Ab}(X)$ and $A_{ji}$, which is a function of electron temperature, $T_e$, can be looked up in the CHIANTI atomic database (see \autoref{subsec:chianti}). $N_{X,k,j}$ is a function of both $T_e$ and $n_e$ and can be computed by assuming the the excitation and deexcitation processes are in equilibrium. This is discussed in \autoref{subsec:collisional_excitation} and \autoref{subsec:level_pops}. $f_{X,k}$ is primarily a function of $T_e$ and is discussed in \autoref{subsec:ionization_recombination} and \autoref{subsec:ioneq_versus_nei}. Thus, for a given distribution of $T_e$ and $n_e$ along the LOS, we can compute the intensity of a transition $\lambda_{ji}$ using \autoref{eq:emissivity_simplified} and \autoref{eq:intensity}.

\subsection{Collisional Excitation of Atomic Levels}\label{subsec:collisional_excitation}

For a photon to be produced by spontaneous radiative decay from excited state $j$ to lower energy state $i$ (see \autoref{eq:radiative_decay}), the ion must first be excited into state $j$. In the solar atmosphere, the most important excitation process is the inelastic collisions between ions and free electrons,
\begin{equation}\label{eq:inelastic_collisions}
    X_{k,i} + e(E_{\textup{initial}}) \to X_{k,j} + e(E_{\textup{final}})
\end{equation}
where $e$ denotes the free electron and $E_{\textup{initial}}$ and $E_{\textup{final}}$ are the initial and final energies of the electron, respectively \citep{phillips_ultraviolet_2008}. The initial and final energies of the ion are $E_i$ and $E_j$, respectively. If $E_i<E_j$, $X_k$ has been \textit{collisionally excited} from a lower to a higher energy state and the free electron has lost an amount of energy equal to the separation between these two levels,
\begin{equation*}
    E_{\textup{final}} - E_{\textup{initial}}  = E_i - E_j.
\end{equation*}
Conversely, if $E_i>E_j$, $X_k$ is \textit{collisionally deexcited} from $i$ to $j$ and the free electron gains an amount of energy equal to $E_i - E_j$.

\hilite{Production of satellite lines via dielectronic recombination important for levels above the ionization potential}

In order to understand how energy levels are populated and depopulated by collisions, it is necessary to compute the rate at which collisions occur in a plasma with electron temperature $T_e$ for an ion $X_k$. I will now derive the excitation and deexcitation rate coefficients. This derivation closely follows the treatment in sections 3.2 and 3.3 of \citet{del_zanna_solar_2018} as well as section 4.2 of \citet{phillips_ultraviolet_2008}.  

The rate coefficient for collisional excitation is given by,
\begin{equation}\label{eq:rate_coefficient}
    C^e_{ij} = \int_{v_0}^{\infty}\textup{d}v\,v\sigma_{ij}(v)f(v),
\end{equation}
where $v$ is the electron velocity, $\sigma_{ij}(v)$ is the cross-section for inelastic collisions between the ion and electron, and $f(v)$ is the velocity distribution function of the electrons. Additionally, $v_0$ is the threshold velocity such that $m_ev_0^2/2 = E_j - E_i$, where $m_e$ is the mass of the electron. Any electron with $v<v_0$ will not be able to excite atom from level $i$ to $j$. It is commonly assumed that the distribution of free electrons in the solar atmosphere is in thermodynamic equilibrium such that it is well-described by a Maxwell-Boltzmann distribution\footnote{Observations of non-thermal particles \citep[e.g][]{dzifcakova_diagnostics_2011} suggest that the distribution of free electrons in the solar corona may be better described by a $\kappa$-distribution. For more details see \citet{cranmer_suprathermal_2014} or the comprehensive review by \citet{dudik_nonequilibrium_2017}.},
\begin{equation}\label{eq:maxwellian}
    f(v) = 4\pi v^2 \left(\frac{m_e}{2\pi k_BT_e}\right)^{3/2}\exp{\left(-\frac{m_ev^2}{2k_BT_e}\right)},
\end{equation}
where $k_B$ is the Boltzmann constant. Plugging \autoref{eq:maxwellian} into \autoref{eq:rate_coefficient},
\begin{equation*}
    C^e_{ij} =  4\pi\left(\frac{m_e}{2\pi k_BT_e}\right)^{3/2}\int_{v_0}^{\infty}\textup{d}v\,v^3\sigma_{ij}(v)\exp{\left(-\frac{m_ev^2}{2k_BT_e}\right)},
\end{equation*}
and making the change of variables $E=m_ev^2/2$,
\begin{align}\label{eq:rate_coefficient_e}
    C^e_{ij} &= 4\pi\left(\frac{m_e}{2\pi k_BT_e}\right)^{3/2}\int_{E_0}^{\infty}\textup{d}E\,\frac{2E}{m_e^2}\sigma_{ij}(E)\exp{\left(-\frac{E}{k_BT_e}\right)},\nonumber\\
    &= \sqrt{\frac{8}{\pi m_e}}(k_BT_e)^{-3/2}\int_{E_0}^{\infty}\textup{d}E\,E\sigma_{ij}(E)\exp{\left(-\frac{E}{k_BT_e}\right)},\nonumber\\
    &= \sqrt{\frac{8k_BT_e}{\pi m_e}}\int_{E_0}^{\infty}\textup{d}\left(\frac{E}{k_BT_e}\right)\,\frac{E}{k_BT_e}\sigma_{ij}(E)\exp{\left(-\frac{E}{k_BT_e}\right)},
\end{align}
where $E_0=mv_0^2/2=E_j-E_i$ is the minimum electron energy required to excite the ion from $i$ to $j$.

The cross-section for excitation by inelastic collisions can be expressed as,
\begin{equation}\label{eq:cross_section}
    \sigma_{ij}(E) = \pi a_0^2 \Omega_{ij}(E)\frac{I_H}{\omega_iE},
\end{equation}
where $a_0$ is the Bohr radius, $I_H$ is the ionization potential of hydrogen, $\omega_i$ is the statistical weight of level $i$, and $\Omega_{ij}$ is the dimensionless collision strength. It should be noted that $\Omega_{ij}$ is symmetric such that $\Omega_{ij}(E)=\Omega(E^{\prime})$, where $E^{\prime}=E - E_{ij} = E - (E_j - E_i)$ is the final energy of the electron after it has been scattered. Plugging \autoref{eq:cross_section} into \autoref{eq:rate_coefficient_e},
\begin{equation}
    C^e_{ij} = I_Ha_0^2\sqrt{\frac{8\pi}{k_Bm_e}}\omega_i^{-1}T_e^{-1/2}\int_{E_0}^{\infty}\textup{d}\left(\frac{E}{k_BT_e}\right)\,\Omega_{ij}(E)\exp{\left(-\frac{E}{k_BT_e}\right)}.
\end{equation}
Exploiting the symmetry of $\Omega_{ij}$ and making a change of variables to $E^{\prime}$ gives,
\begin{align}\label{eq:rate_coefficient_final}
    C^e_{ij} &= I_Ha_0^2\sqrt{\frac{8\pi}{k_Bm_e}}\omega_i^{-1}T_e^{-1/2}\int_{E_0}^{\infty}\textup{d}\left(\frac{E}{k_BT_e}\right)\,\Omega_{ji}(E^\prime)\exp{\left(-\frac{E}{k_BT_e}\right)} \nonumber\\
    &= I_Ha_0^2\sqrt{\frac{8\pi}{k_Bm_e}}\omega_i^{-1}T_e^{-1/2}\int_{0}^{\infty}\textup{d}\left(\frac{E^\prime}{k_BT_e}\right)\,\Omega_{ji}(E^\prime)\exp{\left(-\frac{E^\prime + E_{ij}}{k_BT_e}\right)} \nonumber\\
    &= I_Ha_0^2\sqrt{\frac{8\pi}{k_Bm_e}}T_e^{-1/2}\frac{\Upsilon_{ij}}{\omega_i}\exp{\left(-\frac{E_{ij}}{k_BT_e}\right)}
\end{align}
where the term $\Upsilon_{ij}$, originally introduced by \citet{seaton_electron_1953}, is called the effective collision strength (or alternatively the Maxwellian-averaged collision strength) and is defined as,
\begin{equation}\label{eq:effective_collision_strength}
    \Upsilon_{ij} = \int_{0}^{\infty}\textup{d}\left(\frac{E}{k_BT_e}\right)\,\Omega_{ji}(E)\exp{\left(-\frac{E}{k_BT_e}\right)},
\end{equation}
where $E$ is now the final energy of the electron after the collision.

In general, computing cross-sections for excitations by collisions with free-electrons is very difficult and time consuming and requires the use of sophisticated atomic codes which properly account for the energy levels of the target ion and the detailed physics of the interaction between the free electron and target ion \citep[][section 4.2.3]{phillips_ultraviolet_2008,bautista_theoretical_2000}. \citet{burgess_analysis_1992} computed fit coefficients to $\Upsilon$ as a function of $T_e$ in terms of compact, dimensionless variables for a large number of atomic transitions. Reduced fit parameters for $\Upsilon$ are provided in the CHIANTI atomic database using the methods of \citet{burgess_analysis_1992} for all relevant transitions such that effective collision strengths can be efficiently computed for arbitrary $T_e$. \autoref{fig:upsilon} shows $\Upsilon$ as a function of $T_e$ for several selected transitions of Fe XII.

% spell-checker: disable %
\begin{pycode}[chapter3]
fig = plt.figure(figsize=texfigure.figsize(pytex,scale=1,))
ax = fig.gca()
T = np.logspace(5.5,7.5,100) * u.K
ion = fiasco.Ion('Fe 12', T)
ups = ion.effective_collision_strength()
index = np.where(np.logical_and(ups[0,:] < 1,ups[-1,:]>1e-3))[0][:100]
ax.plot(T, ups[:, index], color=PALETTE[0], alpha=0.25)
ax.set_xlabel(r'$T_e$ $[\si{\kelvin}]$')
ax.set_ylabel(r'$\Upsilon$')
ax.set_xscale('log')
ax.set_yscale('log')
ax.set_xlim(T[[0,-1]].value)
ax.set_ylim(1e-3,1)
tfig = ch3.save_figure('upsilon', fext='.pgf')
tfig.caption = r'Effective collision strength, $\Upsilon$, as a function of $T_e$ for 100 selected transitions in Fe XII. $\Upsilon$ was interpolated to $T_e$ using fit coefficients provided by the CHIANTI atomic database and computed using the method of \citet{burgess_analysis_1992}'
\end{pycode}
\py[chapter3]|tfig|
% spell-checker: enable %

The rate coefficient for deexcitation can also be computed using \autoref{eq:rate_coefficient_final}, the excitation rate coefficient. Under the assumption of thermodynamic equilibrium, the processes of excitation and deexcitation by collisions must be in balance such that 
\begin{equation}\label{eq:eqbm_balance}
    n_in_eC_{ij}^e = n_jn_eC_{ji}^d,
\end{equation}
where $C_{ji}^d$ is the rate coefficient for collisional deexcitation, and the populations of the two levels are in Boltzmann equilibrium,
\begin{equation}\label{eq:boltzmann_eqbm}
    \frac{n_i}{n_j} = \frac{\omega_i}{\omega_j}\exp{\left(\frac{E_{ij}}{k_BT_e}\right)},
\end{equation}
where $\omega_i$ and $\omega_j$ are the statistical weights of levels $i$ and $j$, respectively. Combining \autoref{eq:eqbm_balance} and \autoref{eq:boltzmann_eqbm} gives an expression for $C_{ji}^d$, the deexcitation rate coefficient,
\begin{align}\label{eq:dex_rate_coefficient}
    C_{ji}^d &= \frac{\omega_i}{\omega_j}C_{ij}^e\exp{\left(\frac{E_{ij}}{k_BT_e}\right)},\nonumber\\
    &= I_Ha_0^2\sqrt{\frac{8\pi}{k_Bm_e}}T_e^{-1/2}\frac{\Upsilon_{ij}}{\omega_j}.
\end{align}

\subsection{Level Populations}\label{subsec:level_pops}

In optically-thin, astrophysical plasmas, it is often assumed that the processes which influence populations of atomic energy levels are decoupled from those processes which influence the charge state of the atom (see \autoref{subsec:ionization_recombination}). This is because changes in the energy level populations occur much more frequently than changes in the charge state. Another common approximation is that energy levels are populated primarily by collisional excitation and depopulated by spontaneous radiative decay and that these processes occur primarily between the ground state $g$ and an excited state $j$. Assuming a steady-state equilibrium between these processes,
\begin{equation}\label{eq:coronal_model}
    n_{X,k,g}n_eC_{gj}^e = n_{X,k,j}A_{jg},
\end{equation}
where the left-hand side corresponds to processes that populate $j$ and the right-hand side corresponds to processes that depopulate $j$. Taken together, these assumptions are often referred to as the \textit{coronal model approximation} \citep{bradshaw_collisional_2013,del_zanna_solar_2018}. 

The coronal model approximation assumes a two-level system ($g$ and $j$) in which the only two competing processes are excitation by collisions and spontaneous radiative decay. However, an ion may have so-called \textit{metastable levels} where the probability of spontaneous radiative decay is very low such that depopulation by collisional deexcitation is not negligible \citep{phillips_ultraviolet_2008,del_zanna_solar_2018}. In this case, the level population calculation must account for transitions between excited states such that the two-level approximation is no longer appropriate. Thus, for a multi-level atom, the system of equations required to calculate the population of $n_j$ (temporarily dropping the $X,k$ subscripts),
\begin{equation}\label{eq:level_pop}
\sum_{i>j}n_iA_{ij} + n_e\sum_{i>j}n_iC_{ij}^d + n_e\sum_{i<j}n_iC_{ij}^e
= n_j\left(\sum_{i<j}A_{ji} + n_e\sum_{i<j}C_{ji}^d + n_e\sum_{i>j}C_{ji}^e\right),
\end{equation}
where the left-hand side denotes processes which populate level $j$ and the right-hand side denotes processes that depopulate level $j$ \citep{del_zanna_solar_2018}. $C_{ij}^e$ and $C_{ji}^d$ can be computed from \autoref{eq:rate_coefficient_final} and \autoref{eq:dex_rate_coefficient}, respectively. Values for $A_{ji}$ as a function of $T_e$ are available in CHIANTI. Additional processes such as collisional excitation by protons or photoionization by an external radiation field may also influence $n_j$ \citep[see sections 3.4.1 and 3.4.2 of][]{del_zanna_solar_2018}.

In general, the level population $n_j$ is a function of both temperature and density. As \autoref{eq:level_pop} is a system of $J$ coupled equations, where $J$ is the total number of energy levels of the ion, calculating $n_j$ requires solving a $J\times J$ matrix equation and can be very computationally expensive, depending on the number of energy levels and relevant atomic transitions. \autoref{fig:level-pop} shows the level populations of several energy levels of O II as a function of electron energy at $10^6$ K. The resulting relative level population for level $j$ of charge state $k$ of element $X$, $N_{X,k,j}$, can then be used to compute the emissivity for transition $\lambda_{ji}$ (\autoref{eq:emissivity_simplified}) and the resulting spectral line intensity (\autoref{eq:intensity}).

% spell-checker: disable %
\begin{pycode}[chapter3]
ion = fiasco.Ion('O 2', [1e6]*u.K)
n = np.logspace(3,12,100)*u.cm**(-3)
pop = ion.level_populations(n)

# Function for making spectroscopic notation for energy levels
def make_level_label(i):
    spec = r'$^{s}\mathrm{{{l}}}_{{{j}}}$'.format(
        j = str(Fraction(ion[i].total_angular_momentum.value)),
        s = ion._elvlc['multiplicity'][i],
        l = ion[i].orbital_angular_momentum_label
    )
    return f"{ion[i].level}: {' '.join(ion[i].configuration.split('.'))} {spec}"

fig = plt.figure(figsize=texfigure.figsize(pytex,scale=1,))
ax = fig.gca()
num_levels = 5
for i in range(num_levels):
    ax.plot(n, pop[0,:,i], label=make_level_label(i), color=PALETTE[i])
ax.set_xscale('log')
ax.set_yscale('log')
ax.set_ylim(1e-3,2)
ax.set_xlim(n[0].value,n[-1].value)
ax.set_xlabel(r'$n_e$ $[\si{\cm}^{-3}]$')
ax.set_ylabel(r'$N_j$')
ax.xaxis.set_major_locator(matplotlib.ticker.LogLocator(numticks=5))
ax.legend(loc=4,frameon=False,ncol=2)
tfig = ch3.save_figure('level-pop', fext='.pgf')
tfig.caption = r'Level population of the first five levels of O II as a function of electron density, $n_e$, at $T_e=10^6$ K. Note that the ground state is the most abundant for all $n_e$. The level population is normalized to the total number of O II ions such that $\sum_jN_j=1$. Adapted from Fig. 4.3 of \citet{phillips_ultraviolet_2008}.'
\end{pycode}
\py[chapter3]|tfig|
% spell-checker: enable %

\subsection{Processes which Affect the Ion Charge State}\label{subsec:ionization_recombination}

In addition to the relative populations of each energy level of the ion, one must also know the population of each \textit{charge state} of the ion in order to compute the emissivity (\autoref{eq:emissivity_simplified}). The relative population fraction of a charge state $k$ of element $X$, denoted $f_{X,k}=n_{X,k}/n_X$, is the number of ions of element $X$ in charge state $k$ relative to the total number of ions of element $X$. Ion charge states are determined by two primary processes: \textit{ionization}, in which a bound electron is freed by some external perturbation, and \textit{recombination}, in which a a free electron is captured by the ion. Thus, the time evolution of the population fraction $f_k$ (temporarily dropping the element label) is given by,
\begin{equation}\label{eq:population_fraction}
    \frac{d}{dt}f_k = n_e(\alpha_{k-1}^I f_{k-1} + \alpha_{k+1}^R f_{k+1} - \alpha_{k}^I f_k - \alpha_k^R f_k),
\end{equation}
where $\alpha_k^I$ and $\alpha_k^R$ are the ionization and recombination rates of charge state $k$, respectively, and the population fractions are subject to the constraint $\sum_kf_k=1$ \citep{del_zanna_solar_2018}. In general, the derivative on the left-hand side is the comoving derivative such that $\frac{d}{dt}=\partial/\partial t + v\partial/\partial s$. Note that ionization from lower charge states and recombination from higher charge states are source terms while ionization and recombination out of the current charge state are sinks. Solutions to \autoref{eq:population_fraction} are discussed in \autoref{subsec:ioneq_versus_nei}.

\subsubsection{Ionization}

In optically-thin astrophysical plasmas such as the solar corona, the dominant processes contributing to the total ionization rate are \textit{collisional ionization} and \textit{excitation-autoionization} \citep{bradshaw_collisional_2013}. Thus, the total ionization rate can be written as,
\begin{equation}\label{eq:total_ionization_rate}
    \alpha^I = \alpha^\textup{CI} + \alpha^\textup{EA},
\end{equation}
where $\alpha^\textup{CI}$ and $\alpha^\textup{EA}$ are the ionization rates due collisional ionization and excitation-autoionization, respectively. 

In the process of collisional ionization, a free electron collides with an ion $X_k$ and frees a bound electron. Following the notation of \citet{bradshaw_collisional_2013,mason_spectroscopic_1994}, this can be expressed as,
\begin{equation}\label{eq:collisional_ionization}
    X_{k,i} + e \to X_{k+1,i^\prime} + 2e,
\end{equation}
where $i^\prime$ denotes the final energetic state of $X_{k+1}$. $\alpha_{CI}$ can be computed in a similar manner to $C^e_{ij}$ by integrating the velocity-weighted collision cross-section over a Maxwell-Boltzmann distribution. Using the result from \autoref{eq:rate_coefficient_e}, the ionization rate due to collisional ionization can be written as,
\begin{equation}
    \alpha^\textup{CI} = \sqrt{\frac{8}{\pi m_e}}(k_BT_e)^{-3/2}\int_I^{\infty}\textup{d}E\,E\sigma_{CI}(E)\exp{\left(-\frac{E}{k_BT_e}\right)}
\end{equation}
where $E$ is the energy of incident electron, $\sigma_{CI}$ is the collisional ionization cross-section and $I$ is the ionization energy of the initially-bound electron \citep{del_zanna_solar_2018}. Making the change of variables $x=(E-I)/k_BT_e$ gives,
\begin{equation}\label{eq:collisional_ionization_x}
\begin{aligned}
    \alpha^\textup{CI} = \sqrt{\frac{8k_BT_e}{\pi m_e}}\exp{\left(-\frac{I}{k_BT_e}\right)}&\left(\int_0^{\infty}\textup{d}x\,x\sigma_{CI}(k_BT_ex+I)e^{-x} \right. \\
    &\left. + \frac{I}{k_BT_e}\int_0^{\infty}\textup{d}x\,\sigma_{CI}(k_BT_ex+I)e^{-x}\right).
\end{aligned}
\end{equation}
Notice that both integrals have the same form and can be evaluated using Gauss-Laguerre quadrature,
\begin{equation}
    \int_0^\infty\textup{d}x\,f(x)e^{-x} \approx \sum_{i=1}^n w_if(x_i),
\end{equation}
where $x_i$ is zero of the $i$-th Laguerre polynomial and $w_i$ are the associated weights \citep[see Equation 25.4.45 of][]{abramowitz_handbook_1972}. Note that in both terms, evaluating $f(x_i)$ requires evaluating the collisional ionization cross-section, $\sigma_{CI}$.

As in the case of collisional excitation cross-section, evaluating $\sigma_\textup{CI}$ is non-trivial. For ions in the hydrogen and helium isoelectronic sequences (i.e. ions with the same number of electrons as hydrogen or helium), $\sigma_\textup{CI}$ can be calculated using the fitting formula of \citet{fontes_fully_1999}. Additionally, \citet{dere_ionization_2007} provide fit coefficients for collisional ionization cross-sections for a large number of ions using the method of \citet{burgess_analysis_1992}. Fit parameters for both of these methods are provided by the CHIANTI database and can be used to efficiently compute $\sigma_\textup{CI}$ as a function of $T_e$.

In the case of excitation-autoionization, if an ion is collisionally excited to a level above the ionization threshold, it can autoionize, resulting in a free electron and an ion in a higher charge state, but lower energy state. This process can be written as,
\begin{equation}\label{eq:excitation_autoionization}
    X_{k,i^\prime} + e(E_1) \to X_{k,j} + e(E_2) \to X_{k+1,i} + e(E_2) + e^\prime(E),
\end{equation}
where $e^\prime$ is the recently freed electron \citep{phillips_ultraviolet_2008}. In the first step, $X_k$ is excited from $i^\prime$ to $j$ and the in the second step, $X_k$ decays from $j$ to $i$ and emits an electron $e^\prime$, producing a higher charge state $k+1$. This is only possible provided $E_1 - E_2$ is greater than the ionization threshold of $X_k$ \citep{bradshaw_collisional_2013}. The ionization rate due to excitation-autoionization, $\alpha^\textup{EA}$, can be computed using an expression analogous to \autoref{eq:rate_coefficient_final}, but replacing $\Upsilon$ with the appropriate effective collision strengths for excitation-autoionization. Scaled fit parameters to these collision strengths, as computed by \citet{dere_ionization_2007} using the method of \citet{burgess_analysis_1992}, are provided in the CHIANTI database. \autoref{fig:ionization-recombination-rates} shows the total (solid blue), collisional (dashed blue), and excitation-autoionization (dot-dashed blue) ionization rates as a function of temperature for Fe XVI.   

% spell-checker: disable %
\begin{pycode}[chapter3]
ion = fiasco.Ion('Fe 16', np.logspace(4,9,100)*u.K)
fig = plt.figure(figsize=texfigure.figsize(pytex,scale=1,))
ax = fig.gca()
# ionization
ax.plot(ion.temperature,ion.ionization_rate(),color=PALETTE[0],ls='-',label=r'$\alpha^I$')
ax.plot(ion.temperature,ion.direct_ionization_rate(),color=PALETTE[0],ls='--',label=r'$\alpha^\textup{CI}$')
ax.plot(ion.temperature,ion.excitation_autoionization_rate(),color=PALETTE[0],ls='-.',label=r'$\alpha^\textup{EA}$')
# recombination
ax.plot(ion.temperature,ion.recombination_rate(),color=PALETTE[1],ls='-',label=r'$\alpha^R$')
ax.plot(ion.temperature,ion.radiative_recombination_rate(),color=PALETTE[1],ls='--',label=r'$\alpha^\textup{RR}$')
ax.plot(ion.temperature,ion.dielectronic_recombination_rate(),color=PALETTE[1],ls='-.',label=r'$\alpha^\textup{DR}$')
ax.set_xscale('log')
ax.set_yscale('log')
ax.set_ylim(1e-12,1e-9)
ax.set_xlim(ion.temperature[[0,-1]].value)
ax.set_xlabel(r'$T_e$ $[\si{\kelvin}]$')
ax.set_ylabel(r'$\alpha$ $[\si{\cm}^3\,\si{\second}^{-1}]$')
ax.legend(loc=4,ncol=1,frameon=False)
tfig = ch3.save_figure('ionization-recombination-rates', fext='.pgf')
tfig.caption = r'Ionization (blue) and recombination (orange) rates as a function of electron temperature, $T_e$, for Fe XVI. The constituent rates are denoted by dashed and dot-dashed lines. Note that the recombination rate dominates at low $T_e$ while the ionization rate dominates at high $T_e$, as expected.'
\end{pycode}
\py[chapter3]|tfig|
% spell-checker: enable %

\subsubsection{Recombination}

Along with ionization, recombination, the capture of a free electron by the target ion, is the other primary process which determines the charge state of the ion. In an optically-thin plasma, the two dominant processes that contribute to the total recombination rate are \textit{radiative recombination} and \textit{dielectronic recombination} \citep{bradshaw_collisional_2013}. As in \autoref{eq:total_ionization_rate}, the total recombination rate can be written as,
\begin{equation}\label{eq:total_recombination_rate}
    \alpha^\textup{R} = \alpha^\textup{RR} + \alpha^\textup{DR},
\end{equation}
where $\alpha^\textup{RR}$ and $\alpha^\textup{DR}$ are the recombination rates due to radiative and dielectronic recombination, respectively.

In the case of radiative recombination, a free electron is captured into a bound state and a photon is emitted. This process can be expressed as,
\begin{equation}\label{eq:radiative_recombination}
    X_{k+1,j} + e(E) \to X_{k,i} + h\nu_{ji}.
\end{equation}
Note that energy conservation requires that $h\nu_{ji}=E_j - E_i + E$ such that the energy of the emitted photon must be equal to that of the initial kinetic energy of the electron plus the energy differential between states $j$ and $i$. In general, computing $\alpha^\textup{RR}$ is nontrivial as it requires calculating the photoionization cross-section between $i$ and $j$ as well as the level population of excited state $j$ \citep[see Equation 4.47 of][]{phillips_ultraviolet_2008}. \citet{shull_ionization_1982} calculated $\alpha^\textup{RR}$ for C, N, I, Ne, Mg, Si, S, Ar, Ca, Fe, and Ni using a relatively simple fit function,
\begin{equation}\label{eq:shull_radiative_recombination_rate}
    \alpha^\textup{RR}(T_e) = A\left(\frac{T_e}{10^4}\right)^{-\eta},
\end{equation}
where $A$ and $\eta$ are determined by fitting \autoref{eq:shull_radiative_recombination_rate} to tabulated values of $\alpha^\textup{RR}$ from the literature. \citet{badnell_radiative_2006} later improved on this result by computing distorted-wave photoionization cross-sections for all ions up to and including Zn and calculating fit parameters from these results for a more sophisticated analytical fitting function for $\alpha^\textup{RR}$\citep[see Equation 4 of][]{verner_atomic_1996}. The CHIANTI database uses the results of both \citet{shull_ionization_1982} and \citet{badnell_radiative_2006} to efficiently compute $\alpha^\textup{RR}$ as a function of electron temperature.

Dielectronic recombination is the inverse process of excitation-autoionization (\autoref{eq:excitation_autoionization}) and can be expressed as,
\begin{equation}\label{eq:dielectronic_recombination}
    X_{k+1,i^\prime} + e \to X_{k,j} \to X_{k,i} + h\nu_{ji}.
\end{equation}
Note that in the intermediate step of this process, $X_{k,j}$ is in a doubly-excited state wherein a free electron has been captured and an already-bound electron has been excited to a higher energy level $j$. When the ion decays from $j$ to $i$ and a photon is emitted, the captured electron $e$ remains in an excited energy level \citep{bradshaw_collisional_2013}. The recombination rate due to dielectronic recombination, $\alpha^\textup{DR}$, can be evaluated in a similar manner to $\alpha^\textup{RR}$. \citet{shull_ionization_1982} fit an analytical form for $\alpha^\textup{DR}(T_e)$ to data from the literature and provide fit parameters for the same set of ions as $\alpha^\textup{RR}$. Improved analytical forms and fit parameters for $\alpha^\textup{DR}$ to results obtained from a distorted-wave approximation calculation are provided in a series of 14 papers by \citet{badnell_dielectronic_2003}. As in the case of radiative recombination, the approaches of both \citet{shull_ionization_1982} and \citet{badnell_dielectronic_2003} are used to compute $\alpha^\textup{DR}(T_e)$ in CHIANTI. \autoref{fig:ionization-recombination-rates} shows the total (solid orange), radiative (dashed orange), and dielectronic (dot-dashed orange) recombination rates as a function of $T_e$ for Fe XVI. Note that dielectronic recombination dominates at high temperatures while radiative recombination is more important at low temperatures ($T_e\lesssim3\times10^4$ K).

\subsection{Equilibrium versus Nonequilibrium Charge States}\label{subsec:ioneq_versus_nei}

As noted in \autoref{subsec:ionization_recombination}, there are many methods for computing the ionization and recombination rate coefficients, primarily as a function of electron temperature, $T_e$. One can then use these rate coefficients to compute the relative population fraction of all ions of particular element as a function of temperature. When computing these population fractions for a high-temperature, low-density plasma such as the solar corona, it is often assumed that the charge state of the plasma is in \textit{ionization equilibrium} or that the processes which populate and depopulate a particular charge state are in balance. Under this assumption, \autoref{eq:population_fraction} becomes (temporarily dropping the element label $X$),
\begin{equation}\label{eq:ionization_equilibrium}
    n_e(\alpha_{k-1}^I f_{k-1} + \alpha_{k+1}^R f_{k+1} - \alpha_{k}^I f_k - \alpha_k^R f_k) = 0.
\end{equation}

For element $X$ with $Z+1$ total charge states, where $Z$ is the atomic number of $X$, \autoref{eq:ionization_equilibrium} represents a system of $Z+1$ linear, homogeneous equations and can be expressed in matrix form as,
\begin{equation}\label{eq:ionization_equilibrium_matrix}
    \mathbf{A}\mathbf{F} = \mathbf{0},
\end{equation}
where $\mathbf{F}=(f_1,f_2,\ldots,f_k,\ldots,f_{Z+1})$ is a column vector of length $Z+1$, $\mathbf{A}$ is a $Z+1{\times}Z+1$ matrix containing all of the ionization and recombination rates, and $\mathbf{0}$ is the zero vector with $Z+1$ entries. For a given element $X$ and electron temperature $T_e$, one can compute $\alpha^\textup{I}$ and $\alpha^\textup{R}$ (e.g. using CHIANTI) for all $k$ to find $\mathbf{A}$. To solve \autoref{eq:ionization_equilibrium_matrix}, consider the singular value decomposition (SVD) of $\mathbf{A}$,
\begin{equation}
    \mathbf{A} = \mathbf{U}\mathbf{W}\mathbf{V}^T,
\end{equation}
where $\mathbf{W}$ is a $Z+1{\times}Z+1$ diagonal matrix with singular values ($w_k$) along the diagonal and $\mathbf{U}$ and $\mathbf{V}$ are  square $Z+1{\times}Z+1$ matrices whose columns are orthonormal. Provided $\mathbf{A}$ is singular (i.e. $\det{(\mathbf{A})}=0$), any column of $\mathbf{V}$ for which the corresponding $w_k=0$ is a solution of \autoref{eq:ionization_equilibrium_matrix} \citep{press_numerical_1992}. 

\autoref{fig:ionization-equilibrium} shows the population fractions, $f_{X,k}$ for every ionization state of Fe as a function of electron temperature. As the electron temperature increases, the populations of increasingly higher charge states are populated because the free electrons are more energetic and are capable of releasing more tightly-bound electrons. Conversely, at lower $T_e$, the free electrons have lower energy and recombine into the outer bound states of the target ions such that the lower charge states become more populated \citep{bradshaw_collisional_2013}. Note that the temperature at which each population fraction peaks is the point at which the ionization and recombination rates for that charge state are equal (see \autoref{eq:population_fraction}).

% spell-checker: disable %
\begin{pycode}[chapter3]
fe = fiasco.Element('Fe',np.logspace(4,9,1000)*u.K)
ioneq = fe.equilibrium_ionization()
fig = plt.figure(figsize=texfigure.figsize(pytex,scale=1,height_ratio=0.5))
ax = fig.gca()
for i in fe:
    ax.plot(fe.temperature, ioneq[:,i.charge_state],
            color=PALETTE[i.charge_state],)
    z = i.ionization_stage
    if (2 <= z <= 10) or (16 <= z <= 18) or (24 <= z <= 26):
        ax.text(fe.temperature[np.argmax(ioneq[:,i.charge_state])].value,
                np.max(ioneq[:,i.charge_state]).value,
                f'{fe.atomic_symbol} {roman.toRoman(i.ionization_stage)}',
                horizontalalignment='center', rotation=0,
                fontsize=8)
ax.set_xscale('log')
ax.set_xlim(fe.temperature[[0,-1]].value)
ax.set_ylim(0,1.01)
ax.yaxis.set_major_locator(matplotlib.ticker.FixedLocator(np.arange(0.2,1.2,0.2)))
ax.set_xlabel(r'$T_e$ $[\si{\kelvin}]$')
ax.set_ylabel(r'$f_{X,k}$')
tfig = ch3.save_figure('ionization-equilibrium', fext='.pgf')
tfig.caption = r'Ion population fractions for every ionization state of Fe as a function of $T_e$. The population fractions were computed assuming ionization equilibrium using \autoref{eq:ionization_equilibrium_matrix}. Note that increasingly higher ionization states become populated with increasing electron temperature and vice versa.'
\end{pycode}
\py[chapter3]|tfig|
% spell-checker: enable %

The population fraction, $f_k$, as a function of $T_e$ can be accurately determined by solving \autoref{eq:ionization_equilibrium} provided that the charge states the are in equilibrium with the electron temperature of the plasma. This is a reasonable approximation provided that the electron temperature of the plasma changes sufficiently slowly as some finite amount time is required for the charge states to rearrange themselves following a dramatic change in temperature \citep{bradshaw_collisional_2013}. The time required for a charge state $k$ to reach equilibrium following a change in temperature from $T_0$ to $T_1$ in a plasma of density $n_e$ can be expressed as,
\begin{equation}\label{eq:cie_timescale}
    \tau_\textup{CIE} = \frac{1}{n_e(\alpha_{k-1}^I(T_1) f_{k-1}(T_0) + \alpha_{k+1}^R(T_1) f_{k+1}(T_0) - \alpha_{k}^I(T_1) f_k(T_0) - \alpha_k^R(T_1) f_k(T_0))},
\end{equation}
where $\tau_\textup{CIE}$ is often called the collisional ionization equilibration timescale (CIE). If $T_e$ changes from $T_0$ to $T_1$ in a time less than $\tau_\textup{CIE}$, then the charge state $k$ is out of equilibrium and $f_k$ must be computed by solving the full time-dependent population fraction equation (\autoref{eq:population_fraction}). \citet{smith_ionization_2010} computed the maximum $\tau_\textup{CIE}$ for several different elements and found that for a plasma of density $n_e=10^9$ cm$^{-3}$, the time needed to equilibrate to within 10\% of the equilibrium population fractions of Fe was at least $\ge200$ s for $T_e\ge10^6$ K and approached several thousand seconds for much higher temperatures ($10^9$ K).

In a low-density, high-temperature plasma such as the solar corona which can undergo temperature changes on timescales of a few hundred or even tens of seconds (e.g. flares, heating by nanoflares), the temperature implied by the equilibrium charge states may not be representative of the actual electron temperature. As such, correctly accounting for nonequilibrium ionization (NEI) is critical for understanding the radiative losses from the coronal plasma. \citet{macneice_numerical_1984} solved the full time-dependent ionization/recombination equations, including effects due to radiative and collisional excitation and deexcitation, in order to accurately model the spectrum of Ca in a flaring loop heated by an electron beam. Later, \citet{bradshaw_numerical_2009} developed a robust, explicit numerical scheme for solving \autoref{eq:population_fraction} and provided an exhaustive set of test cases for various temperature and density gradients. Many workers \citep[e.g.][]{hansteen_new_1993,reale_nonequilibrium_2008,bradshaw_radiative_2003,bradshaw_explosive_2006,bradshaw_what_2011,bradshaw_quantifying_2019} have also found that NEI is a critically important when attempting to accurately predict spectral intensities of an impulsively heated, low-density plasma. In particular, effects due to nonequilibrium ionization are likely to limit the observability of ``very hot'' plasma, one of the primary observable signatures of nanoflare heating (see \autoref{ch:inferring_hot_plasma}).

% spell-checker: disable %
\begin{pycode}[chapter3]
# Setup temperature and density profiles
t = np.arange(0,100,0.05) * u.s
thalf = t[-1]/2
Tmax = 1e7*u.K
Tmin = 1e5*u.K
T = np.where(t <= thalf, Tmin + t*(Tmax-Tmin)/(thalf),
             Tmax + (t - thalf)*(Tmin - Tmax)/(t[-1] - thalf))*Tmax.unit
n = 1e9*u.cm**(-3) * np.ones(t.shape)
# Compute NEI
el = synthesizAR.atomic.Element('iron', np.logspace(4,9,1000)*u.K)
nei = el.non_equilibrium_ionization(t,T,n)
# Interpolate IEQ populations
ioneq = el.equilibrium_ionization()
ioneq_interp = interp1d(el.temperature.value, ioneq.value.T, 
                        kind='cubic',fill_value='extrapolate')(T.value).T
# Plot
fig = plt.figure(figsize=texfigure.figsize(pytex,scale=1,height_ratio=0.55))
## Population fractions
ax = fig.gca()
for i in range(9,15):
    ax.plot(t, ioneq_interp[:,i], color=PALETTE[i],ls='--')
    ax.plot(t, nei[:,i], color=PALETTE[i],ls='-',
            label=f'{el.atomic_symbol} {roman.toRoman(el[i].ionization_stage)}')
ax.set_ylim(1e-6,1)
ax.set_yscale('log')
ax.set_xlim(t[[0,-1]].value)
ax.set_xlabel(r'$t$ $[\si{\second}]$')
ax.set_ylabel(r'$f_{X,k}$')
ax.yaxis.set_major_locator(matplotlib.ticker.LogLocator(numticks=4))
ax.tick_params(axis='x', which='both', pad=6)
## Temperature
ax2 = ax.twinx()
ax2.plot(t,T,color='k',ls='-',alpha=0.5)
ax2.set_xlim(t[[0,-1]].value)
ax2.set_ylim(Tmin.value,Tmax.value)
ax2.set_yscale('log')
ax2.set_ylabel(r'$T_e$ $[\si{\kelvin}]$')
ax2.tick_params(axis='y', which='both', pad=6)
ax.legend(ncol=3,bbox_to_anchor=(0.5,1),frameon=False,loc='lower center')
tfig = ch3.save_figure('nonequilibrium-ionization', fext='.pgf')
tfig.caption = r'Equilibrium (dashed) and nonequilibrium (solid) population fractions as a function of time, $t$, for Fe X through Fe XV. The time-dependent temperature profile, $T_e$, is shown on the right axis in black. The density is held constant at $n_e=10^9$ $\si{\cm}^{-3}$ for the entire simulation interval.'
\end{pycode}
\py[chapter3]|tfig|
% spell-checker: enable %

\autoref{fig:nonequilibrium-ionization} shows the population fractions of Fe X through Fe XV in equilibrium (dashed) and nonequilibrium (solid). In this simple example, the electron temperature (black) increases linearly from $10^5$ K to $10^7$ K over 50 s and then decreases linearly back to $10^5$ K over 50 s. The density is held constant at $10^9$ cm$^{-3}$ for the entire 100 s. Note that for all 6 ions shown, the population fractions are out of equilibrium for the entire 100 s and may differ by many orders of magnitude. In particular, the peaks of the nonequilibrium population fractions lag those of the equilibrium populations as a finite amount of time is required for the charge state to form following a change in $T_e$. Additionally, unlike the equilibrium populations, which track the electron temperature exactly, the nonequilibrium populations are not symmetric about the peak in $T_e$. The equilibrium populations were determined by computing the SVD of the matrix $\mathbf{A}$ in \autoref{eq:ionization_equilibrium_matrix} and the nonequilibrium populations were computed by solving \autoref{eq:population_fraction} using an implicit method (see \autoref{ap:nonequilibrium_implicit}).

\section{Continuum Emission}\label{sec:continuum}

\hilite{Not sure if this section is needed since we don't deal with continuum much though it is still an important mechanism; do this last}

\subsection{Free-free Emission}

\subsection{Free-bound Emission}

\section{The Differential Emission Measure Distribution}\label{sec:dem}

\hilite{Write intensity in terms of contribution function; define contribution function; define DEM}

\autoref{eq:intensity}, the intensity for a transition $\lambda_{ji}$, can be alternatively expressed as,
\begin{equation}
    I(\lambda_{ji}) = \int_\textup{LOS}\textup{d}h\,n_Hn_eG_{ji},
\end{equation}
where $G_{ji}$, the so-called \textit{contribution function}, is given by,
\begin{equation}\label{eq:contribution_function}
    G_{ji} = \frac{1}{4\pi n_e}\frac{hc}{\lambda_{ji}}\textup{Ab}(X)f_{X,k}N_{X,k,j}A_{ji}.
\end{equation}
Note that several variants of $G_{ji}$ exist in the literature such as dropping the factor of $\frac{1}{4\pi}$, including the $n_H/n_e\approx0.83$ term, or dropping the abundance factor $\textup{Ab}(X)$ \citep[see section 3.1 of][]{del_zanna_solar_2018}.

\subsection{Inversion Methods}

\subsection{The Emission Measure Slope}

\subsection{Inferring the Presence of Very Hot Plasma}

\section{Time-lag Analysis}\label{sec:timelag}

% spell-checker: disable %
\begin{pycode}[chapter3timelag]
name = 'chapter3'
ch3_timelag = texfigure.Manager(
    pytex,
    os.path.join('.', name),
    number=3,
    **{k: os.path.join('.', name, v) for k,v in manager_opts.items()}
)
from synthesizAR.analysis import cross_correlation
\end{pycode}
% spell-checker: enable %

% Need some intro here that describes in brief what time lag analysis is and why we would use it.
% Just a few sentences is fine. All details will go below

\subsection{Cross-correlation}\label{subsec:cross_correlation}

The \textit{cross-correlation} measures the similarity between two signals as a function of the offset betwen them. Given two signals $f_A$ and $f_B$ that are a function of time $t$, the cross-correlation, $\crosscor$, can be written as,
\begin{equation}
    \crosscor = (f_A\star f_B)(\tau) = \int_{-\infty}^\infty\textup{d}t\,f_A^{\ast}(t)f_B(t + \tau),
\end{equation}
where $\tau$ is the temporal offset between $f_A$ and $f_B$ and $f_A^{\ast}$ denotes the complex conjugate of $f_A$. Alternatively, $\crosscor$ can be expressed in terms of the convolution,
\begin{equation}\label{eq:cross_correlation_convolution}
    \crosscor = f_A(-t) \ast f_B(t),
\end{equation}
where $\ast$ denotes the convolution operator. Taking the Fourier transform of both sides of \autoref{eq:cross_correlation_convolution} and using the convolution theorem \citep[section 20.4]{arfken_mathematical_2013} gives,
\begin{align}\label{eq:cross_correlation_final}
    \fourier{\crosscor} &= \fourier{f_A(-t) \ast f_B(t)}, \nonumber \\
    \fourier{\crosscor} &= \fourier{f_A(-t)}\fourier{f_B(t)}, \nonumber \\
    \crosscor &= \inversefourier{\fourier{f_A(-t)}\fourier{f_B(t)}},
\end{align}
where $\mathcal{F}$ denotes the Fourier transform. \autoref{eq:cross_correlation_final} defines the cross-correlation $\crosscor$ between two signals $f_A$ and $f_B$ as a function of temporal offset $\tau$ in terms of the Fourier transform. Defining the cross-correlation in this manner allows one to efficiently compute $\crosscor$ using highly-optimized fast Fourier transform (FFT) algorithms \citep[e.g. the widely-used FFT algorithm developed by][]{cooley_algorithm_1965}. Note that $f_A$ and $f_B$ are standardized such that both signals have zero mean and unit standard deviation (i.e. $\mu_{A,B}=0$, $\sigma_{A,B}=1$). Additionally, $\crosscor$ is scaled by the length of the signal such that the cross-correlation is always between $-1$ (perfectly anti-correlated) and $+1$ (perfectly correlated).

% spell-checker: disable %
\begin{pycode}[chapter3timelag]
# Compute cross-correlation between Gaussian pulses
def gaussian_pulse(x,x0,sigma):
    return np.exp(-(x - x0)**2/(2*sigma**2))
t = np.linspace(-100,100,100000)*u.s
fA = gaussian_pulse(t,0.25*u.s,0.05*u.s)
fB = gaussian_pulse(t,0.75*u.s,0.05*u.s)
lag,cc = cross_correlation(t,fA,fB)
# Plot
fig,axes = plt.subplots(1,2,figsize=texfigure.figsize(pytex,scale=1,height_ratio=0.5))
## Gaussian pulses
axes[0].plot(t,fA,label='$f_1$', color=PALETTE[0])
axes[0].plot(t,fB,label='$f_2$', color=PALETTE[1])
axes[0].legend(loc='upper center',frameon=False)
axes[0].set_xlim(0,1)
axes[0].set_ylim(0,1.05)
axes[0].set_xlabel(r'$t$ $[\si{\second}]$')
axes[0].set_ylabel(r'$f$ $[\textup{arb. unit}]$')
axes[0].yaxis.set_major_locator(matplotlib.ticker.MaxNLocator(prune='lower',nbins=6))
## Cross-correlation
axes[1].plot(lag, cc, color=PALETTE[0])
axes[1].axvline(x=0, ls='--', color='k',lw=1)
axes[1].set_xlabel(r'$\tau$ $[\si{\second}]$')
axes[1].set_ylabel(r'$\mathcal{C}_{12}$',)
axes[1].set_xlim(-1,1)
axes[1].set_ylim(0,1.05)
axes[1].yaxis.set_major_locator(matplotlib.ticker.MaxNLocator(nbins=6,prune='lower'))
plt.subplots_adjust(wspace=0.3)
tfig = ch3_timelag.save_figure('cross-correlation-example', fext='.pgf')
tfig.caption = r'The left panel shows two Gaussian signals $f_1$ and $f_2$ with peaks at \SI{0.25}{\second} (blue) and \SI{0.75}{\second} (orange), respectively. The right panel shows the cross-correlation $\crosscor[12]$ between $f_1$ and $f_2$ as a function of the offset $\tau$. The dashed black line denotes $\tau=0$ \si{\second}. Note that $\crosscor[12]$ peaks at $\tau=0.5$ \si{\second}, the separation in $t$ between the peaks of $f_1$ and $f_2$.'
\end{pycode}
\py[chapter3timelag]|tfig|
% spell-checker: enable %

A simple example of the cross-correlation is illustrated in \autoref{fig:cross-correlation-example} for two Gaussian pulses, $f_1$ and $f_2$. The right panel shows the two pulses as a function of $t$, with $f_1$ and $f_2$ peaking at \SI{0.25}{\second} and \SI{0.75}{\second}, respectively. The right panel shows the cross-correlation, $\crosscor[12]$, as computed by \autoref{eq:cross_correlation_final}. $\crosscor[12]$ peaks at $\tau=0.5$ \si{\second}, the separation in $t$ between the peaks of $f_1$ and $f_2$. For a more conceptual understanding of $\crosscor[12]$, consider fixing $f_2$ and shifting $f_1$ forward and backward in $t$. The degree to which $f_1$ and $f_2$ overlap or the ``similarity'' between the two signals is analogous to $\crosscor[12]$. $\crosscor[12]$ peaks at $\tau=0.5$ \si{\second} because $f_1$ and $f_2$ are most overlapping when $f_1$ is shifted by \SI{0.5}{\second} relative to its initial position. Throughout the rest of this thesis, I will refer to the value of $\tau$ which maximizes the cross-correlation as the \textit{time lag}. In this example, the time lag between $f_1$ and $f_2$ is 0.5 s. Note that for $\crosscor[21]$ (i.e. $f_1$ and $f_2$ reversed), the time lag would be -0.5 s as $f_2$ would need to be shifted 0.5 s to the left in order to maximize the similarity between the two signals. Thus, the order of the two signals in \autoref{eq:cross_correlation_final} will determine the sign of the timelag.

\subsection{Temperature Sensitivity of the AIA Passbands}\label{subsec:aia_response}

% Briefly discuss how temperature response functions are calculated
% show plot of temperature response
% show wavelength response as well?

Before discussing the time lag in the context of AIA observations, it is important to understand the temperature sensitivity of the EUV passbands of the AIA instrument. The AIA instrument onboard the SDO spacecraft is comprised of four dual-channel normal-incidence telescopes which have continuously observed the full Sun (\SI{41}{\arcminute} field of view) since 29 April 2010 at a cadence of \SIrange{10}{12}{\second} and spatial resolution of $\approx\SI{0.6}{\arcsecond}$ per pixel \citep{lemen_atmospheric_2012,boerner_initial_2012}. In addition to two ultraviolet (UV, \SIlist{1600;1700}{\angstrom}) channels and one visible (\SI{4500}{\angstrom}) channel, AIA has seven extreme ultraviolet (EUV) channels: \SIlist{94;131;171;193;211;304;335}{\angstrom}. Unlike the other EUV channels which are primarily sensitive to hot ($T\ge10^{5.8}$ \si{\kelvin}) lines in high ionization states of Fe, the \SI{304}{\angstrom} channel is dominated by the much cooler \SI{303.784}{\angstrom} He II line \citep[see Table 1 of][]{lemen_atmospheric_2012}. This line forms primarily in the chromosphere and is optically-thick, meaning its observed intensity is not well-modeled by \autoref{eq:intensity} and data in the CHIANTI database \citep{boerner_initial_2012,warren_solar_2005}. Because the primary focus of this thesis is the dynamics of hot plasma in \AR s, diagnostics will be limited to the six remaining channels: \SIlist{94;131;171;193;211;335}{\angstrom}. \autoref{tab:aia_channels} summarizes the solar features, dominant Fe ions, and characteristic temperature of each of the channels.

\begin{table}
    \centering
    \caption{Primary ions observed by the six AIA EUV channels of interest. Adapted from Table 1 of \citet{lemen_atmospheric_2012}.\label{tab:aia_channels}}
    \begin{tabularx}{\columnwidth}{cclC}
        \toprule
        Channel $[\si{\angstrom}]$ & Primary ion(s) & Solar feature & Characteristic temperature $[\si{\kelvin}]$ \\
        \midrule
        94 & Fe XVIII & flaring corona & $10^{6.8}$ \\
        131 & Fe VIII, XXI & TR, flaring corona & $10^{5.6},10^7$ \\
        171 & Fe IX & quiet corona, upper TR & $10^{5.8}$ \\
        193 & Fe XII, XXIV & corona, hot flare plasma & $10^{6.2},10^{7.3}$ \\
        211 & Fe XIV & active region & $10^{6.3}$ \\
        335 & Fe XVI & active region & $10^{6.4}$ \\
        \bottomrule
    \end{tabularx}
\end{table}

For any of the aforementioned EUV channels of AIA, the intensity as observed by a particular channel $c$ can be written as,
\begin{equation}\label{eq:aia_intensity}
    p_c = \int_\textup{LOS}\textup{d}h\,n_Hn_eK_c(T_e),
\end{equation}
where $K_c$ is the temperature response function of channel $c$ and is given by,
\begin{equation}\label{eq:temperature_response}
    K_c = \int_0^\infty\mathrm{d}\lambda\,G(\lambda)R_c(\lambda),
\end{equation}
where $G(\lambda)$ is the total contribution function of all ions and $R_c$ is the wavelength response of channel $c$ \citep{boerner_initial_2012}. Note that \autoref{eq:aia_intensity} gives the intensity in units of DN pixel$^{-1}$ \si{\second}$^{-1}$ such that $K_c$ has units DN pixel$^{-1}$ \si{\second}$^{-1}$ \si{\cm}$^{5}$ and $R_c$ has units $\si{\cm}^2$ DN photon$^{-1}$ $\si{\steradian}$ pixel$^{-1}$. The wavelength response function incorporates all of the properties of the telescope channel, including the geometrical collecting area, the reflectance of the mirrors, the transmission efficiency of the filters, the quantum efficiency of the CCD, and the plate scale \citep[see Section 2 and Table 2 of][]{boerner_initial_2012}. An additional correction is applied to account for the degradation of the instrument over time. The wavelength response functions for the six EUV channels of interest are shown in \autoref{fig:aia-wavelength-response}.

% spell-checker: disable %
\begin{pycode}[chapter3timelag]
aia = InstrumentSDOAIA([0,1]*u.s, None)
fig,axes = plt.subplots(2,3,sharey=True,
                        figsize=texfigure.figsize(pytex,scale=1,height_ratio=2/3))
for c,ax in zip(aia.channels, axes.flatten()):
    wave = np.linspace(c['wavelength'].value-10, c['wavelength'].value+10, 100)*u.angstrom
    r = splev(wave.value, c['wavelength_response_spline'])
    ax.plot(wave, r/r.max())
    ax.set_xlim(c['wavelength'].value-10, c['wavelength'].value+10)
    ax.text(c['wavelength'].value+4, 0.85, f'{c["wavelength"].value:.0f} '+ r'$\si{\angstrom}$',
            fontsize=plt.rcParams['legend.fontsize'])
axes[1,0].set_xlabel(r'$\lambda$ $[\si{\angstrom}]$')
axes[1,0].set_ylabel(r'$R_c/\max{R_c}$')
axes[1,0].set_ylim(0,1.05)
tfig = ch3_timelag.save_figure('aia-wavelength-response', fext='.pgf')
tfig.caption = r'AIA wavelength response functions for the six primary EUV channels. For each channel, the response function is shown at $\pm\SI{10}{\angstrom}$ of the nominal wavelength. Each response function is normalized to the maximum value of $R_c$ over this interval.'
\end{pycode}
\py[chapter3timelag]|tfig|
% spell-checker: enable %

While $R_c$ is only a function of the properties of the instrument, the temperature sensitivity of each channel, $K_c$ (\autoref{eq:temperature_response}), has an explicit dependence on the atomic data through the total contribution function, $G(\lambda)$. $G(\lambda)$ includes components from both line and continuum emission such that \autoref{eq:temperature_response} can be expressed more practically as,
\begin{equation}\label{eq:temperature_response_discrete}
    K_c = \int_0^\infty\textup{d}\lambda\,P_{\textup{cont.}}(\lambda)R_c(\lambda)  + \sum_{\{ji\}}\,\frac{G_{ji}}{hc/\lambda_{ji}}R_c(\lambda_{ji}),
\end{equation}
where $P_{\textup{cont.}}$ is the continuum emissivity and $G_{ji}$ is the contribution function for an atomic transition $\lambda_{ji}$ (\autoref{eq:contribution_function}) and the sum is taken over $\{ji\}$, the set of all known atomic transitions for the relevant wavelength range of channel $c$. Note that $hc/\lambda_{ji}$ is the energy per photon of wavelength $\lambda_{ji}$ such that $G_{ji}/(hc/\lambda_{ji})$ has units of photon $\si{\cm}^3$ $\si{\second}^{-1}$. The set of relevant atomic transitions, $\{ji\}$, can be obtained from the CHIANTI database such that accurately determining the temperature sensitivity of the passbands depends critically on knowledge of the relevant atomic transitions in the bandpass of each channel. The temperature response functions for the EUV channels of AIA are shown in \autoref{fig:aia-temperature-response}. Combined, the six response functions provide temperature coverage over the range $3\times10^5\lesssim T\lesssim2\times10^7$ \si{\kelvin}. Note that several of the response functions, particulary the \SI{94}{\angstrom} and \SI{131}{\angstrom} channels, are doubly-peaked in temperature. This degeneracy, combined with the finite width of the temperature response functions, makes associating intensities of particular channels with specific temperatures very difficult.

% spell-checker: disable %
\begin{pycode}[chapter3timelag]
fig = plt.figure(figsize=texfigure.figsize(pytex,scale=1,))
ax = fig.gca()
T = np.logspace(4,9,1000)*u.K
for i,c in enumerate(aia.channels):
    r = splev(T.value,c['temperature_response_spline'])
    ax.plot(
        T, r,
        label=f'{c["wavelength"].value:.0f} '+ r'$\si{\angstrom}$',
        color=PALETTE[i])
ax.set_xscale('log')
ax.set_yscale('log')
ax.set_xlim(1e5,1e8)
ax.set_ylim(1e-28,2e-24)
ax.set_xlabel(r'$T$ $[\si{\kelvin}]$')
ax.set_ylabel(r'$K_c$ $[\textup{DN}\,\si{\cm}^5\,\si{\second}^{-1}\,\textup{pixel}^{-1}]$')
ax.legend(loc=1,frameon=False,ncol=2)
tfig = ch3_timelag.save_figure('aia-temperature-response', fext='.pgf')
tfig.caption = r'Temperature response functions for the six EUV channels of AIA listed in \autoref{tab:aia_channels} as computed by \autoref{eq:temperature_response_discrete}. Together, these six channels provide observational coverage over the temperature range $3\times10^5\lesssim T\lesssim2\times10^7$ \si{\kelvin}.'
\end{pycode}
\py[chapter3timelag]|tfig|
% spell-checker: enable %

\subsection{Time lag between AIA Channel Pairs}\label{subsec:timelag_aia}

% Discuss time lag in context of AIA; relate time lag to cooling time between channel pairs
% Show example with a AIA lightcurves synthesized from a cooling loop; show timelags for all 15 channel pairs (or a subset)

\section{Summary}

% Nomenclature
\nomenclature[z-au]{AU}{astronomical unit}
\nomenclature[z-dem]{DEM}{differential emission measure}
\nomenclature[a-h]{$h$}{Planck constant}
\nomenclature[a-c]{$c$}{speed of light in a vacuum}
\nomenclature[g-nu]{$\nu$}{photon frequency}
\nomenclature[g-lambda]{$\lambda$}{wavelength}
\nomenclature[s-k]{$k$}{ionization stage}
\nomenclature[z-los]{LOS}{line-of-sight}
\nomenclature[z-nei]{NEI}{nonequilibrium ionization}
\nomenclature[a-te]{$T_e$}{electron temperature}
\nomenclature[a-ne]{$n_e$}{electron density}
\nomenclature[a-kb]{$k_B$}{Boltzmann constant}
\nomenclature[x-fourier]{$\mathcal{F}$}{Fourier transform}
\nomenclature[x-crosscorrelation]{$\mathcal{C}$}{cross-correlation}
\nomenclature[z-fft]{FFT}{fast Fourier transform}
\nomenclature[z-arcmin]{\si{\arcminute}}{arcminute}
\nomenclature[z-arcsec]{\si{\arcsecond}}{arcsecond}
\nomenclature[z-euv]{EUV}{extreme ultraviolet}
\nomenclature[z-dn]{DN}{digital number, equivalent to counts}
